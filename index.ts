import { Level } from "level"
import path from "path"
import os from "os"
import { extensionId, key } from "./common"

let extId = process.env.EXT_ID || extensionId
// Determine the path to the Chrome LevelDB storage (this path may vary)
// Adjust the path according to your OS and Chrome version
let leveldbPath: string
if (os.platform() === "darwin") {
  leveldbPath = path.join(
    os.homedir(),
    "Library",
    "Application Support",
    "com.operasoftware.OperaGX",
    // "Google",
    // "Chrome",
    // "Default",
    "Local Extension Settings",
    extId
  )
} else {
  console.error("os not supported")
  process.exit(1)
}

console.log({ leveldbPath })
// Open the LevelDB database
const db = new Level(leveldbPath, { valueEncoding: "json" })

// db.close()
// Fetch the value stored by the Chrome extension

let key = "_chrome.storage.local." + "userName"

console.log({ key })

await db.put(key, "bow")

await db
  .get(key)
  .then((value: string) => {
    console.log("Stored value:", value)
  })
  .catch((err: any) => {
    console.error({ err })
    if (err.notFound) {
      console.log("Value not found")
    } else {
      console.error("Error reading value:", err)
    }
  })
  .finally(() => {
    // Close the database
    db.close((err: any) => {
      if (err) console.error("Error closing database:", err)
    })
  })

db.close((err) => {
  if (err) console.error("Error closing database:", err)
})
